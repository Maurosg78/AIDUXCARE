de2c8f23fe098615ce7b40c6f26d2314
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const langfuse_node_1 = require("langfuse-node");
const langfuse = new langfuse_node_1.Langfuse({
    publicKey: process.env.VITE_LANGFUSE_PUBLIC_KEY || '',
    secretKey: process.env.VITE_LANGFUSE_SECRET_KEY || '',
    baseUrl: process.env.VITE_LANGFUSE_HOST || 'https://cloud.langfuse.com'
});
// Campos críticos que deben estar presentes
const CRITICAL_FIELDS = [
    'chiefComplaint',
    'symptoms',
    'diagnosis',
    'treatmentPlan',
    'prognosis',
    'followUp'
];
// Reglas de consistencia
const CONSISTENCY_RULES = [
    {
        name: 'diagnosis_without_symptoms',
        check: (fields) => fields.diagnosis && !fields.symptoms,
        message: 'Diagnóstico presente sin síntomas asociados'
    },
    {
        name: 'treatment_without_diagnosis',
        check: (fields) => fields.treatmentPlan && !fields.diagnosis,
        message: 'Plan de tratamiento presente sin diagnóstico previo'
    },
    {
        name: 'prognosis_without_diagnosis',
        check: (fields) => fields.prognosis && !fields.diagnosis,
        message: 'Pronóstico presente sin diagnóstico previo'
    }
];
async function evaluatePatientVisit(traceId) {
    try {
        // Obtener el trace específico
        const trace = await langfuse.getTrace(traceId);
        if (!trace) {
            throw new Error(`Trace no encontrado: ${traceId}`);
        }
        const patientId = trace.metadata?.patientId;
        if (!patientId) {
            throw new Error('Trace sin patientId en metadata');
        }
        // Recolectar todos los campos del formulario
        const formFields = {};
        trace.observations?.forEach(obs => {
            if (obs.name === 'form.update' && obs.input?.field) {
                formFields[obs.input.field] = obs.input.value;
            }
        });
        // Verificar campos críticos
        const missingFields = CRITICAL_FIELDS.filter(field => !formFields[field] || formFields[field].trim() === '');
        // Verificar reglas de consistencia
        const warnings = CONSISTENCY_RULES
            .filter(rule => rule.check(formFields))
            .map(rule => rule.message);
        // Calcular score de completitud
        const completenessScore = Math.round(((CRITICAL_FIELDS.length - missingFields.length) / CRITICAL_FIELDS.length) * 100);
        return {
            patientId,
            completenessScore,
            missingFields,
            warnings
        };
    }
    catch (error) {
        console.error('Error en evaluación:', error);
        throw error;
    }
}
describe('Evaluaciones de Visitas Estructuradas', () => {
    let testTraceId;
    beforeAll(async () => {
        // Obtener un trace real para pruebas
        const traces = await langfuse.getTraces({
            limit: 1,
            name: 'form.update'
        });
        if (traces.data.length > 0) {
            testTraceId = traces.data[0].id;
        }
        else {
            throw new Error('No se encontraron traces para pruebas');
        }
    });
    test('debe detectar campos faltantes', async () => {
        const result = await evaluatePatientVisit(testTraceId);
        expect(result).toHaveProperty('patientId');
        expect(result).toHaveProperty('completenessScore');
        expect(result).toHaveProperty('missingFields');
        expect(result).toHaveProperty('warnings');
        expect(result.completenessScore).toBeGreaterThanOrEqual(0);
        expect(result.completenessScore).toBeLessThanOrEqual(100);
        expect(Array.isArray(result.missingFields)).toBe(true);
        expect(Array.isArray(result.warnings)).toBe(true);
    });
    test('debe detectar inconsistencias en los datos', async () => {
        const result = await evaluatePatientVisit(testTraceId);
        // Verificar que las advertencias son coherentes
        result.warnings.forEach(warning => {
            expect(typeof warning).toBe('string');
            expect(warning.length).toBeGreaterThan(0);
        });
    });
    test('debe calcular correctamente el score de completitud', async () => {
        const result = await evaluatePatientVisit(testTraceId);
        // El score debe ser proporcional a los campos faltantes
        const expectedScore = Math.round(((CRITICAL_FIELDS.length - result.missingFields.length) / CRITICAL_FIELDS.length) * 100);
        expect(result.completenessScore).toBe(expectedScore);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hdXJpY2lvc29iYXJ6by9EZXNrdG9wL0FJRFVYQ0FSRS9fX3Rlc3RzX18vc3RydWN0dXJlZFZpc2l0LmV2YWxzLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSxpREFBeUM7QUFHekMsTUFBTSxRQUFRLEdBQUcsSUFBSSx3QkFBUSxDQUFDO0lBQzVCLFNBQVMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLHdCQUF3QixJQUFJLEVBQUU7SUFDckQsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLElBQUksRUFBRTtJQUNyRCxPQUFPLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsSUFBSSw0QkFBNEI7Q0FDeEUsQ0FBQyxDQUFDO0FBU0gsNENBQTRDO0FBQzVDLE1BQU0sZUFBZSxHQUFHO0lBQ3RCLGdCQUFnQjtJQUNoQixVQUFVO0lBQ1YsV0FBVztJQUNYLGVBQWU7SUFDZixXQUFXO0lBQ1gsVUFBVTtDQUNYLENBQUM7QUFFRix5QkFBeUI7QUFDekIsTUFBTSxpQkFBaUIsR0FBRztJQUN4QjtRQUNFLElBQUksRUFBRSw0QkFBNEI7UUFDbEMsS0FBSyxFQUFFLENBQUMsTUFBMkIsRUFBRSxFQUFFLENBQ3JDLE1BQU0sQ0FBQyxTQUFTLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUTtRQUN0QyxPQUFPLEVBQUUsNkNBQTZDO0tBQ3ZEO0lBQ0Q7UUFDRSxJQUFJLEVBQUUsNkJBQTZCO1FBQ25DLEtBQUssRUFBRSxDQUFDLE1BQTJCLEVBQUUsRUFBRSxDQUNyQyxNQUFNLENBQUMsYUFBYSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVM7UUFDM0MsT0FBTyxFQUFFLHFEQUFxRDtLQUMvRDtJQUNEO1FBQ0UsSUFBSSxFQUFFLDZCQUE2QjtRQUNuQyxLQUFLLEVBQUUsQ0FBQyxNQUEyQixFQUFFLEVBQUUsQ0FDckMsTUFBTSxDQUFDLFNBQVMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTO1FBQ3ZDLE9BQU8sRUFBRSw0Q0FBNEM7S0FDdEQ7Q0FDRixDQUFD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TCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxxREFBcUQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNyRSxNQUFNLE1BQU0sR0FBRyxNQUFNLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRXZELHdEQUF3RDtRQUN4RCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUM5QixDQUFDLENBQUMsZUFBZSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxHQUFHLGVBQWUsQ0FBQyxNQUFNLENBQUMsR0FBRyxHQUFHLENBQ3hGLENBQUM7UUFFRixNQUFNLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ3ZELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21hdXJpY2lvc29iYXJ6by9EZXNrdG9wL0FJRFVYQ0FSRS9fX3Rlc3RzX18vc3RydWN0dXJlZFZpc2l0LmV2YWxzLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTGFuZ2Z1c2UgfSBmcm9tICdsYW5nZnVzZS1ub2RlJztcbmltcG9ydCB7IFBhdGllbnRFdmFsIH0gZnJvbSAnLi4vc3JjL3R5cGVzL0V2YWx1YXRpb24nO1xuXG5jb25zdCBsYW5nZnVzZSA9IG5ldyBMYW5nZnVzZSh7XG4gIHB1YmxpY0tleTogcHJvY2Vzcy5lbnYuVklURV9MQU5HRlVTRV9QVUJMSUNfS0VZIHx8ICcnLFxuICBzZWNyZXRLZXk6IHByb2Nlc3MuZW52LlZJVEVfTEFOR0ZVU0VfU0VDUkVUX0tFWSB8fCAnJyxcbiAgYmFzZVVybDogcHJvY2Vzcy5lbnYuVklURV9MQU5HRlVTRV9IT1NUIHx8ICdodHRwczovL2Nsb3VkLmxhbmdmdXNlLmNvbSdcbn0pO1xuXG5pbnRlcmZhY2UgRXZhbFJlc3VsdCB7XG4gIHBhdGllbnRJZDogc3RyaW5nO1xuICBjb21wbGV0ZW5lc3NTY29yZTogbnVtYmVyO1xuICBtaXNzaW5nRmllbGRzOiBzdHJpbmdbXTtcbiAgd2FybmluZ3M6IHN0cmluZ1tdO1xufVxuXG4vLyBDYW1wb3MgY3LDrXRpY29zIHF1ZSBkZWJlbiBlc3RhciBwcmVzZW50ZXNcbmNvbnN0IENSSVRJQ0FMX0ZJRUxEUyA9IFtcbiAgJ2NoaWVmQ29tcGxhaW50JyxcbiAgJ3N5bXB0b21zJyxcbiAgJ2RpYWdub3NpcycsXG4gICd0cmVhdG1lbnRQbGFuJyxcbiAgJ3Byb2dub3NpcycsXG4gICdmb2xsb3dVcCdcbl07XG5cbi8vIFJlZ2xhcyBkZSBjb25zaXN0ZW5jaWFcbmNvbnN0IENPTlNJU1RFTkNZX1JVTEVTID0gW1xuICB7XG4gICAgbmFtZTogJ2RpYWdub3Npc193aXRob3V0X3N5bXB0b21zJyxcbiAgICBjaGVjazogKGZpZWxkczogUmVjb3JkPHN0cmluZywgYW55PikgPT4gXG4gICAgICBmaWVsZHMuZGlhZ25vc2lzICYmICFmaWVsZHMuc3ltcHRvbXMsXG4gICAgbWVzc2FnZTogJ0RpYWduw7NzdGljbyBwcmVzZW50ZSBzaW4gc8OtbnRvbWFzIGFzb2NpYWRvcydcbiAgfSxcbiAge1xuICAgIG5hbWU6ICd0cmVhdG1lbnRfd2l0aG91dF9kaWFnbm9zaXMnLFxuICAgIGNoZWNrOiAoZmllbGRzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KSA9PiBcbiAgICAgIGZpZWxkcy50cmVhdG1lbnRQbGFuICYmICFmaWVsZHMuZGlhZ25vc2lzLFxuICAgIG1lc3NhZ2U6ICdQbGFuIGRlIHRyYXRhbWllbnRvIHByZXNlbnRlIHNpbiBkaWFnbsOzc3RpY28gcHJldmlvJ1xuICB9LFxuICB7XG4gICAgbmFtZTogJ3Byb2dub3Npc193aXRob3V0X2RpYWdub3NpcycsXG4gICAgY2hlY2s6IChmaWVsZHM6IFJlY29yZDxzdHJpbmcsIGFueT4pID0+IFxuICAgICAgZmllbGRzLnByb2dub3NpcyAmJiAhZmllbGRzLmRpYWdub3NpcyxcbiAgICBtZXNzYWdlOiAnUHJvbsOzc3RpY28gcHJlc2VudGUgc2luIGRpYWduw7NzdGljbyBwcmV2aW8nXG4gIH1cbl07XG5cbmFzeW5jIGZ1bmN0aW9uIGV2YWx1YXRlUGF0aWVudFZpc2l0KHRyYWNlSWQ6IHN0cmluZyk6IFByb21pc2U8RXZhbFJlc3VsdD4ge1xuICB0cnkge1xuICAgIC8vIE9idGVuZXIgZWwgdHJhY2UgZXNwZWPDrWZpY29cbiAgICBjb25zdCB0cmFjZSA9IGF3YWl0IGxhbmdmdXNlLmdldFRyYWNlKHRyYWNlSWQpO1xuICAgIGlmICghdHJhY2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJhY2Ugbm8gZW5jb250cmFkbzogJHt0cmFjZUlkfWApO1xuICAgIH1cblxuICAgIGNvbnN0IHBhdGllbnRJZCA9IHRyYWNlLm1ldGFkYXRhPy5wYXRpZW50SWQ7XG4gICAgaWYgKCFwYXRpZW50SWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVHJhY2Ugc2luIHBhdGllbnRJZCBlbiBtZXRhZGF0YScpO1xuICAgIH1cblxuICAgIC8vIFJlY29sZWN0YXIgdG9kb3MgbG9zIGNhbXBvcyBkZWwgZm9ybXVsYXJpb1xuICAgIGNvbnN0IGZvcm1GaWVsZHM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcbiAgICB0cmFjZS5vYnNlcnZhdGlvbnM/LmZvckVhY2gob2JzID0+IHtcbiAgICAgIGlmIChvYnMubmFtZSA9PT0gJ2Zvcm0udXBkYXRlJyAmJiBvYnMuaW5wdXQ/LmZpZWxkKSB7XG4gICAgICAgIGZvcm1GaWVsZHNbb2JzLmlucHV0LmZpZWxkXSA9IG9icy5pbnB1dC52YWx1ZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIFZlcmlmaWNhciBjYW1wb3MgY3LDrXRpY29zXG4gICAgY29uc3QgbWlzc2luZ0ZpZWxkcyA9IENSSVRJQ0FMX0ZJRUxEUy5maWx0ZXIoZmllbGQgPT4gXG4gICAgICAhZm9ybUZpZWxkc1tmaWVsZF0gfHwgZm9ybUZpZWxkc1tmaWVsZF0udHJpbSgpID09PSAnJ1xuICAgICk7XG5cbiAgICAvLyBWZXJpZmljYXIgcmVnbGFzIGRlIGNvbnNpc3RlbmNpYVxuICAgIGNvbnN0IHdhcm5pbmdzID0gQ09OU0lTVEVOQ1lfUlVMRVNcbiAgICAgIC5maWx0ZXIocnVsZSA9PiBydWxlLmNoZWNrKGZvcm1GaWVsZHMpKVxuICAgICAgLm1hcChydWxlID0+IHJ1bGUubWVzc2FnZSk7XG5cbiAgICAvLyBDYWxjdWxhciBzY29yZSBkZSBjb21wbGV0aXR1ZFxuICAgIGNvbnN0IGNvbXBsZXRlbmVzc1Njb3JlID0gTWF0aC5yb3VuZChcbiAgICAgICgoQ1JJVElDQUxfRklFTERTLmxlbmd0aCAtIG1pc3NpbmdGaWVsZHMubGVuZ3RoKSAvIENSSVRJQ0FMX0ZJRUxEUy5sZW5ndGgpICogMTAwXG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICBwYXRpZW50SWQsXG4gICAgICBjb21wbGV0ZW5lc3NTY29yZSxcbiAgICAgIG1pc3NpbmdGaWVsZHMsXG4gICAgICB3YXJuaW5nc1xuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZW4gZXZhbHVhY2nDs246JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59XG5cbmRlc2NyaWJlKCdFdmFsdWFjaW9uZXMgZGUgVmlzaXRhcyBFc3RydWN0dXJhZGFzJywgKCkgPT4ge1xuICBsZXQgdGVzdFRyYWNlSWQ6IHN0cmluZztcblxuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIC8vIE9idGVuZXIgdW4gdHJhY2UgcmVhbCBwYXJhIHBydWViYXNcbiAgICBjb25zdCB0cmFjZXMgPSBhd2FpdCBsYW5nZnVzZS5nZXRUcmFjZXMoe1xuICAgICAgbGltaXQ6IDEsXG4gICAgICBuYW1lOiAnZm9ybS51cGRhdGUnXG4gICAgfSk7XG4gICAgXG4gICAgaWYgKHRyYWNlcy5kYXRhLmxlbmd0aCA+IDApIHtcbiAgICAgIHRlc3RUcmFjZUlkID0gdHJhY2VzLmRhdGFbMF0uaWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gc2UgZW5jb250cmFyb24gdHJhY2VzIHBhcmEgcHJ1ZWJhcycpO1xuICAgIH1cbiAgfSk7XG5cbiAgdGVzdCgnZGViZSBkZXRlY3RhciBjYW1wb3MgZmFsdGFudGVzJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGV2YWx1YXRlUGF0aWVudFZpc2l0KHRlc3RUcmFjZUlkKTtcbiAgICBcbiAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgncGF0aWVudElkJyk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ2NvbXBsZXRlbmVzc1Njb3JlJyk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ21pc3NpbmdGaWVsZHMnKTtcbiAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgnd2FybmluZ3MnKTtcbiAgICBcbiAgICBleHBlY3QocmVzdWx0LmNvbXBsZXRlbmVzc1Njb3JlKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDApO1xuICAgIGV4cGVjdChyZXN1bHQuY29tcGxldGVuZXNzU2NvcmUpLnRvQmVMZXNzVGhhbk9yRXF1YWwoMTAwKTtcbiAgICBcbiAgICBleHBlY3QoQXJyYXkuaXNBcnJheShyZXN1bHQubWlzc2luZ0ZpZWxkcykpLnRvQmUodHJ1ZSk7XG4gICAgZXhwZWN0KEFycmF5LmlzQXJyYXkocmVzdWx0Lndhcm5pbmdzKSkudG9CZSh0cnVlKTtcbiAgfSk7XG5cbiAgdGVzdCgnZGViZSBkZXRlY3RhciBpbmNvbnNpc3RlbmNpYXMgZW4gbG9zIGRhdG9zJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGV2YWx1YXRlUGF0aWVudFZpc2l0KHRlc3RUcmFjZUlkKTtcbiAgICBcbiAgICAvLyBWZXJpZmljYXIgcXVlIGxhcyBhZHZlcnRlbmNpYXMgc29uIGNvaGVyZW50ZXNcbiAgICByZXN1bHQud2FybmluZ3MuZm9yRWFjaCh3YXJuaW5nID0+IHtcbiAgICAgIGV4cGVjdCh0eXBlb2Ygd2FybmluZykudG9CZSgnc3RyaW5nJyk7XG4gICAgICBleHBlY3Qod2FybmluZy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnZGViZSBjYWxjdWxhciBjb3JyZWN0YW1lbnRlIGVsIHNjb3JlIGRlIGNvbXBsZXRpdHVkJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGV2YWx1YXRlUGF0aWVudFZpc2l0KHRlc3RUcmFjZUlkKTtcbiAgICBcbiAgICAvLyBFbCBzY29yZSBkZWJlIHNlciBwcm9wb3JjaW9uYWwgYSBsb3MgY2FtcG9zIGZhbHRhbnRlc1xuICAgIGNvbnN0IGV4cGVjdGVkU2NvcmUgPSBNYXRoLnJvdW5kKFxuICAgICAgKChDUklUSUNBTF9GSUVMRFMubGVuZ3RoIC0gcmVzdWx0Lm1pc3NpbmdGaWVsZHMubGVuZ3RoKSAvIENSSVRJQ0FMX0ZJRUxEUy5sZW5ndGgpICogMTAwXG4gICAgKTtcbiAgICBcbiAgICBleHBlY3QocmVzdWx0LmNvbXBsZXRlbmVzc1Njb3JlKS50b0JlKGV4cGVjdGVkU2NvcmUpO1xuICB9KTtcbn0pOyAiXSwidmVyc2lvbiI6M30=